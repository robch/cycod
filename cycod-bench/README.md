# CycodBench: SWE-bench Benchmark Runner

CycodBench is a .NET-based benchmark runner for evaluating the performance of the `cycod` agent on the SWE-bench dataset. It handles distributed execution through sharding, generates multiple candidate solutions per problem, and uses an ensemble approach to select the best solution.

CycodBench borrows some ideas/constructs from the [Augment Code swebench runner](https://github.com/augmentcode/augment-swebench-agent) project, but is specific to the CycoDev tools suite.

## System Overview

The CycodBench system is designed to:

1. Load and process SWE-bench problems in batches
2. Distribute work across multiple shards
3. Generate multiple candidate solutions per problem
4. Evaluate each solution against test cases
5. Ensemble the results to select the best solution
6. Calculate overall performance metrics

## Architecture

The system consists of the following main components:

- **[Program](Program.md)**: Entry point and command-line interface
- **[BenchmarkRunner](BenchmarkRunner.md)**: Orchestrates the benchmark execution process
- **[DatasetManager](DatasetManager.md)**: Loads and manages the SWE-bench dataset from Hugging Face
- **[ShardManager](ShardManager.md)**: Handles sharding of the dataset for distributed processing
- **[ProblemProcessor](ProblemProcessor.md)**: Processes individual problems, manages candidate solutions
- **[DockerManager](DockerManager.md)**: Manages Docker containers for isolated problem environments
- **[AgentExecutor](AgentExecutor.md)**: Executes the `cycod` agent inside Docker containers
- **[EvaluationToolsManager](EvaluationToolsManager.md)**: Manages SWE-bench evaluation tools setup and execution
- **[EvaluationService](EvaluationService.md)**: Evaluates solutions against test cases
- **[EnsemblerService](EnsemblerService.md)**: Selects the best solution from multiple candidates
- **[ResultManager](ResultManager.md)**: Manages storage and retrieval of benchmark results
- **[Models](Models.md)**: Data models used throughout the system
- **[Configuration](Configuration.md)**: Configuration management for the benchmark runner
- **[Logger](Logger.md)**: Logging system for the benchmark runner

## Execution Flow

### 1. Setting Up the Environment

```bash
# Install SWE-bench evaluation tools
CycodBench.exe setup

# Download the SWE-bench dataset
CycodBench.exe download
```

### 2. Starting a Batch Run

```bash
CycodBench.exe run --shard-count 10 --shard-id 2 --candidates 8 --parallelism 8
```

### 3. Problem Processing Flow

For each problem assigned to the current shard:

1. Setup a workspace directory
2. For each candidate solution:
   - Launch a Docker container with the problem codebase
   - Copy the agent executable into the container
   - Execute the agent with the problem statement
   - Evaluate the generated solution
   - Store the results
3. Save the candidate solutions to a shard-specific results file

### 4. Post-Processing

After all shards complete, additional steps are performed:

```bash
# Merge shards
CycodBench.exe merge --input shard1.jsonl shard2.jsonl ... --output merged_results.jsonl

# Run ensemble
CycodBench.exe ensemble --input merged_results.jsonl --output final_results.json
```

## Key Files and Directories

During execution, the system creates:

- **Workspace directory**: Contains all problem-specific files
  - **agent_logs.txt**: Detailed logs from the agent's execution
  - **predictions.json**: The diff generated by the agent
  - **evaluation_results.json**: The evaluation results

## Dependencies

- .NET 8.0+
- Docker
- Access to SWE-bench Docker images
- `cycod` agent executable

## Dependency Injection

CycodBench uses the .NET dependency injection container to manage service lifetimes and dependencies. Services are registered in the Program.cs file and injected where needed. The application follows these DI principles:

1. Constructor injection for required dependencies
2. Registration of services with appropriate lifetimes:
   - Singleton: Configuration, Logger, DatasetManager, EvaluationToolsManager
   - Scoped: BenchmarkRunner, ShardManager, ResultManager
   - Transient: ProblemProcessor, AgentExecutor, DockerManager (when container-specific)

3. Interface-based design to support testability and modularity
4. Service provider pattern for top-level composition

## Implementation plan

We'll be following the implementation plan as outlined in the [cycod-punch-list.md](cycod-punch-list.md) file.
