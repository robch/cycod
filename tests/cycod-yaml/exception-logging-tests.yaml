name: Exception Logging Tests - cycod
description: Tests exception logging functionality for the cycod CLI application
tags: [cycod, logger]

tests:
  - name: Generate exception and verify exception files are created
    script: |
      dotnet run --project ../../src/cycod/cycod.csproj -- chat --use-openai --openai-api-key "bogus-key" --question "test"
    expect-exit-code: 1
    expect-regex:
      - "EXCEPTION: HTTP 401 \\(invalid_request_error: invalid_api_key\\)"
      - "Incorrect API key provided: bogus-key"
      - "SAVED: exception-chat-history-.*\\.jsonl"
      - "SAVED: exception-trajectory-.*\\.md" 
      - "SAVED: exception-log-.*\\.log"
    not-expect-regex:
      - "SAVED: .*\\.jsonl" # Should not save regular chat history
      - "SAVED: .*\\.md" # Should not save regular trajectory

  - name: Verify exception chat history file contains system prompt and user input
    script: |
      dotnet run --project ../../src/cycodmd/cycodmd.csproj -- exception-chat-history-*.jsonl
    expect-regex:
      - "## exception-chat-history-.*\\.jsonl"
      - '"role":"system"'
      - '"role":"user"'
      - '"content":"test"'
      - "Project Context from AGENTS.md"

  - name: Verify exception trajectory file contains user input
    script: |
      dotnet run --project ../../src/cycodmd/cycodmd.csproj -- exception-trajectory-*.md
    expect-regex:
      - "## exception-trajectory-.*\\.md"
      - "> test"

  - name: Verify exception log file contains stack trace
    script: |
      dotnet run --project ../../src/cycodmd/cycodmd.csproj -- exception-log-*.log
    expect-regex:
      - "## exception-log-.*\\.log"
      - "EXCEPTION: HTTP 401 \\(invalid_request_error: invalid_api_key\\)"
      - "Incorrect API key provided: bogus-key"
      - "System\\.ClientModel\\.ClientResultException"
      - "at OpenAI\\.ClientPipelineExtensions\\.ProcessMessageAsync"
      - "at FunctionCallingChat\\.CompleteChatStreamingAsync"

  - name: Verify cycod-specific exception log file contains detailed logging
    script: |
      dotnet run --project ../../src/cycodmd/cycodmd.csproj -- exception-log-cycod-*.log
    expect-regex:
      - "## exception-log-cycod-.*\\.log"
      - "Memory logger initialized"
      - "Starting cycod, version"
      - "Memory logger configured to dump to exception-log-cycod-.* only on abnormal exit"
      - "Logging system fully initialized"
      - "Unhandled exception: HTTP 401"
      - "LOG: FATAL: Unhandled exception"

  - name: Verify no exception files are left as turds after cleanup
    script: |
      rm -f exception-*
      git status --porcelain
    not-expect-regex:
      - "exception-"

  - name: Clean up any remaining exception files
    script: |
      rm -f exception-chat-history-* exception-trajectory-* exception-log-*